#!/usr/bin/env python3
import http.server
import json
import subprocess
import os
import sys
from urllib.parse import urlparse, parse_qs

class VSCodeAPIHandler(http.server.BaseHTTPRequestHandler):
    def do_GET(self):
        parsed_path = urlparse(self.path)
        
        if parsed_path.path == '/api/vscode/status':
            self.handle_status()
        else:
            self.send_error(404, "Not Found")
    
    def do_POST(self):
        parsed_path = urlparse(self.path)
        
        if parsed_path.path == '/api/vscode/start':
            self.handle_start()
        elif parsed_path.path == '/api/vscode/stop':
            self.handle_stop()
        else:
            self.send_error(404, "Not Found")
    
    def handle_status(self):
        try:
            result = subprocess.run(['s6-svstat', '/run/service/code-server'], 
                                  capture_output=True, text=True, timeout=5)
            if result.returncode == 0 and 'up' in result.stdout:
                status = 'running'
            else:
                status = 'stopped'
            
            self.send_json_response({'status': 'success', 'vscode_status': status})
        except Exception as e:
            self.send_json_response({'status': 'error', 'message': str(e)}, 500)
    
    def handle_start(self):
        try:
            # Start the service
            result = subprocess.run(['s6-rc', '-u', 'change', 'code-server'], 
                                  capture_output=True, text=True, timeout=10)
            
            # Wait a moment and check status
            import time
            time.sleep(2)
            
            status_result = subprocess.run(['s6-svstat', '/run/service/code-server'], 
                                         capture_output=True, text=True, timeout=5)
            
            if status_result.returncode == 0 and 'up' in status_result.stdout:
                self.send_json_response({
                    'status': 'success', 
                    'message': 'VS Code started successfully',
                    'vscode_status': 'running'
                })
            else:
                self.send_json_response({
                    'status': 'error', 
                    'message': 'Failed to start VS Code',
                    'vscode_status': 'stopped'
                }, 500)
                
        except Exception as e:
            self.send_json_response({'status': 'error', 'message': str(e)}, 500)
    
    def handle_stop(self):
        try:
            # Stop the service
            result = subprocess.run(['s6-rc', '-d', 'change', 'code-server'], 
                                  capture_output=True, text=True, timeout=10)
            
            # Wait a moment and check status
            import time
            time.sleep(1)
            
            status_result = subprocess.run(['s6-svstat', '/run/service/code-server'], 
                                         capture_output=True, text=True, timeout=5)
            
            if status_result.returncode == 0 and 'down' in status_result.stdout:
                self.send_json_response({
                    'status': 'success', 
                    'message': 'VS Code stopped successfully',
                    'vscode_status': 'stopped'
                })
            else:
                # Even if status check fails, if s6-rc succeeded, consider it stopped
                self.send_json_response({
                    'status': 'success', 
                    'message': 'VS Code stop command sent',
                    'vscode_status': 'stopped'
                })
                
        except Exception as e:
            self.send_json_response({'status': 'error', 'message': str(e)}, 500)
    
    def send_json_response(self, data, status_code=200):
        self.send_response(status_code)
        self.send_header('Content-Type', 'application/json')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
        self.wfile.write(json.dumps(data).encode())
    
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
    
    def log_message(self, format, *args):
        # Suppress default logging
        pass

if __name__ == '__main__':
    port = 8081
    print(f"Starting VS Code API server on port {port}")
    
    try:
        server = http.server.HTTPServer(('localhost', port), VSCodeAPIHandler)
        server.serve_forever()
    except KeyboardInterrupt:
        print("\nShutting down API server")
        server.shutdown()
    except Exception as e:
        print(f"Error starting API server: {e}")
        sys.exit(1) 