name: Build and Test InfluxDB Stack

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      run: |
        cd influxdb-stack
        docker build -t influxdb-stack:test .
    
    - name: Run container
      run: |
        docker run -d \
          --name influxdb-stack-test \
          --init \
          -p 8086:8086 \
          -p 3000:3000 \
          -p 8443:8443 \
          -p 80:80 \
          influxdb-stack:test
    
    - name: Wait for services
      run: |
        echo "Waiting for services to start..."
        sleep 30
        
        # Check InfluxDB
        curl -f http://localhost:8086/health || exit 1
        
        # Check Grafana
        curl -f http://localhost:3000/api/health || exit 1
        
        # Check NGINX
        curl -f http://localhost:80/nginx_status || exit 1
    
    - name: Show logs on failure
      if: failure()
      run: |
        echo "=== Container logs ==="
        docker logs influxdb-stack-test
        
        echo "=== Container processes ==="
        docker exec influxdb-stack-test ps aux
    
    - name: Cleanup
      if: always()
      run: |
        docker stop influxdb-stack-test || true
        docker rm influxdb-stack-test || true

  # Test with different architectures
  multi-arch-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build for ${{ matrix.arch }}
      run: |
        cd influxdb-stack
        docker buildx build \
          --platform linux/${{ matrix.arch }} \
          --tag influxdb-stack:test-${{ matrix.arch }} \
          --load \
          . 